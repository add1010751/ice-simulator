<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8" />
  <title>å†°æ©Ÿæ¨¡æ“¬å™¨</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    h1 { text-align: center; }
    .controls { text-align: center; margin-bottom: 20px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    #result { white-space: pre-line; background: white; padding: 10px; border-radius: 10px; border: 1px solid #ccc; max-height: 300px; overflow-y: auto; }
    .progress { width: 100%; background-color: #ddd; border-radius: 5px; overflow: hidden; margin-top: 20px; }
    .progress-bar { height: 20px; background-color: #4CAF50; width: 0%; text-align: center; color: white; }
    #summary { background: white; padding: 10px; border-radius: 10px; border: 1px solid #ccc; max-height: 300px; overflow-y: auto; margin-top: 20px; }
    li { margin-bottom: 3px; }
    #recentSImages {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
      padding: 6px;
      background: white;
      border-radius: 10px;
      border: 1px solid #ccc;
      max-height: 340px;
      overflow-x: auto;
    }
    #recentSImages img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #fff;
      cursor: pointer;
    }
    #probabilities {
      margin-top: 40px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    #bannerSelect { position: absolute; top: 10px; left: 10px; }
  </style>
</head>
<body>
  <select id="bannerSelect" onchange="switchBanner()"></select>
  <h1 id="bannerTitle">å†°æ©Ÿæ¨¡æ“¬å™¨</h1>
  <div class="controls">
    <button onclick="draw(1)">å–®æŠ½</button>
    <button onclick="draw(10)">10é€£æŠ½</button>
    <button onclick="draw(30)">30é€£æŠ½</button>
    <button onclick="draw(100)">100é€£æŠ½</button>
    <button onclick="resetAll()">ğŸ”„ é‡ç½®</button>
  </div>
  <div class="controls">
    <input type="number" id="customDrawCount" placeholder="è¼¸å…¥æŠ½æ•¸" min="1" style="width: 80px; margin-left: 10px;" />
    <button onclick="drawCustom()">é€£æŠ½</button>
  </div>
  <div class="progress">
    <div class="progress-bar" id="pityBar">0%</div>
  </div>
  <p>ä¿åº•æ¬¡æ•¸ï¼š<span id="pityCount">0</span></p>
  <p>ç´¯ç©æŠ½æ•¸ï¼š<span id="totalDraws">0</span> æ¬¡</p>
  <p>ç¸½èŠ±è²»ï¼š<span id="totalCost">0</span> å…ƒ (48NT/æŠ½)</p>
  <h3>ç²å¾—çš„[S]é“å…·</h3>
  <div id="recentSImages"></div>
  <h3>æŠ½å–ç´€éŒ„</h3>
  <div id="result"></div>
  <h3>å„çé …ç²å¾—æ¬¡æ•¸çµ±è¨ˆ</h3>
  <ul id="summary"></ul>
  <h3>å„çé …æ©Ÿç‡</h3>
  <div id="probabilities">
    <ul id="probabilitiesList"></ul>
  </div>

<script>
  // çæ± åç¨±åˆ—è¡¨ï¼ˆæª”åï¼Œå°æ‡‰ banners/*.jsonï¼‰
  const bannersList = ["å„ç‘ç»æ–¯çš„å“€æ­Œ", "è–‡å¡”èŠ³å¡”å¨œ", "æ·±æ·µçš„å­˜åœ¨"];

  let currentBanner = bannersList[0];
  let banners = {};  // å·²è¼‰å…¥çš„çæ± è³‡æ–™
  let items = [];
  let pityRates = { S: 0.10, A: 0.15, B: 0.20, C: 0.40 };
  let pity = 0, pityCount = 0, totalDraws = 0;
  const costPerDraw = 48;
  const stats = {};
  const recentSImages = [], recentSNames = [];

  // åˆå§‹åŒ–é¸å–®èˆ‡é è¼‰é¦–å€‹çæ± 
  function init() {
    const select = document.getElementById("bannerSelect");
    bannersList.forEach(b => {
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      select.appendChild(opt);
    });
	
	
    loadBanner(currentBanner).then(() => {
      switchBanner();
    }).catch(err => alert("è¼‰å…¥çæ± å¤±æ•—ï¼š" + err));
  }

  // fetch è¼‰å…¥çæ±  json
  function loadBanner(bannerKey) {
    return fetch(`data/${bannerKey}.json`)
      .then(res => {
        if (!res.ok) throw new Error("ç„¡æ³•è¼‰å…¥ " + bannerKey + " json");
        return res.json();
      })
      .then(data => {
        banners[bannerKey] = data;
      });
  }

  // åˆ‡æ›çæ± 
  function switchBanner() {
    const select = document.getElementById("bannerSelect");
    currentBanner = select.value;

    if (banners[currentBanner]) {
      items = banners[currentBanner].items;
      document.getElementById("bannerTitle").textContent = banners[currentBanner].title;
      resetAll();
      updateProbabilities();
    } else {
      loadBanner(currentBanner).then(() => {
        items = banners[currentBanner].items;
        document.getElementById("bannerTitle").textContent = banners[currentBanner].title;
        resetAll();
        updateProbabilities();
      }).catch(err => alert("è¼‰å…¥çæ± å¤±æ•—ï¼š" + err));
    }
  }

  // æŠ½çé‚è¼¯
  function draw(times) {
    let resultArr = [];
    for (let i = 0; i < times; i++) {
      const item = roll();
      totalDraws++;
      if (item[2] === "S" && item[3]) {
        recentSImages.unshift(item[3]);
        recentSNames.unshift(item[0]);
      }
      let line = item[2] === "S"
        ? `<span style="color:red;">ç¬¬${totalDraws}æŠ½ï¼š[${item[2]}]${item[0]}</span>`
        : `ç¬¬${totalDraws}æŠ½ï¼š[${item[2]}]${item[0]}`;
      resultArr.push(line);
      pity += pityRates[item[2]];
      stats[item[0]] = (stats[item[0]] || 0) + 1;
      if (pity >= 100) {
        pity = 0;
        pityCount++;
        resultArr.push(`<span style="color:blue;">ã€ä¿åº•${pityCount}æ¬¡é”æˆï¼ã€‘ğŸ‰</span>`);
      }
    }

    // æœ€æ–°æŠ½çé¡¯ç¤ºåœ¨ä¸Šé¢
    resultArr.reverse();
    document.getElementById("result").innerHTML = resultArr.join("\n") + "<br>" + document.getElementById("result").innerHTML;

    updateProgress();
    updateStats();
    updateDisplay();
    updateRecentSImages();
  }

  // æ ¹æ“šæ©Ÿç‡æ»¾æŠ½çå“
  function roll() {
    const rand = Math.random();
    let acc = 0;
    for (const item of items) {
      acc += item[1];
      if (rand < acc) return item;
    }
    return items[items.length - 1];
  }

  // æ›´æ–°é€²åº¦æ¢èˆ‡æ•¸å€¼
  function updateProgress() {
    document.getElementById("pityBar").style.width = pity + "%";
    document.getElementById("pityBar").textContent = pity.toFixed(2) + "%";
    document.getElementById("pityCount").textContent = pityCount;
  }

  // æ›´æ–°å„çé …çµ±è¨ˆ
  function updateStats() {
    const summary = document.getElementById("summary");
    summary.innerHTML = "";
    for (const item of items) {
      const name = item[0];
      const rarity = item[2];
      const count = stats[name];
      if (count > 0) {
        const li = document.createElement("li");
        li.textContent = `[${rarity}] ${name} Ã— ${count}`;
        summary.appendChild(li);
      }
    }
  }

  // æ›´æ–°æŠ½æ•¸èˆ‡èŠ±è²»é¡¯ç¤º
  function updateDisplay() {
    document.getElementById("totalCost").textContent = totalDraws * costPerDraw;
    document.getElementById("totalDraws").textContent = totalDraws;
  }

  // é¡¯ç¤ºæœ€è¿‘æŠ½åˆ°çš„ S é“å…·åœ–ç‰‡
  function updateRecentSImages() {
    const container = document.getElementById("recentSImages");
    container.innerHTML = "";
    for (let i = 0; i < recentSImages.length; i++) {
      const img = document.createElement("img");
      img.src = recentSImages[i];
      img.title = recentSNames[i];
      container.appendChild(img);
    }
  }

  // é‡ç½®æ‰€æœ‰ç‹€æ…‹
  function resetAll() {
    pity = 0; pityCount = 0; totalDraws = 0;
    recentSImages.length = 0; recentSNames.length = 0;
    for (const key in stats) stats[key] = 0;
    document.getElementById("result").innerHTML = "";
    updateProgress(); updateStats(); updateDisplay(); updateRecentSImages();
  }

  // è‡ªè¨‚æŠ½æ•¸è§¸ç™¼
  function drawCustom() {
    const input = document.getElementById('customDrawCount');
    let count = parseInt(input.value, 10);

    if (isNaN(count) || count <= 0) {
      alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•´æ•¸æŠ½æ•¸");
      return;
    }

    if (count == 48763) {
      alert("æ˜Ÿçˆ†æ°£æµæ–¬");
    } else if (count == 114514) {
      alert("ã„ã„ã‚ˆï¼ã“ã„ã‚ˆï¼");
    } else if (count > 100000) {
      alert("æŠ½æ•¸ä¸èƒ½è¶…é100000");
      return;
    }
    draw(count);
  }

  // æ›´æ–°çé …æ©Ÿç‡åˆ—è¡¨
  function updateProbabilities() {
    const probDiv = document.getElementById("probabilitiesList");
    probDiv.innerHTML = items.map(item => {
      const rarity = item[2];
      const name = item[0];
      const prob = item[1];
      const probPercent = (prob * 100).toFixed(4).replace(/0+$/, '').replace(/\.$/, '');
      return `<div>[${rarity}] ${name} - ${probPercent}%</div>`;
    }).join("");
  }

  window.onload = () => {
    init();
  };
</script>

</body>
</html>
